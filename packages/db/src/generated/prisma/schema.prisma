// Optimized Prisma schema for Employee Management System
// With cascading deletes on all relations

generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===============================
// ENUMS - Centralized and Clear
// ===============================

enum UserRole {
  ADMIN
  TEAM_LEADER
  EMPLOYEE
  HR_MANAGER
  SUPER_ADMIN
  CUSTOMER
}

enum RatingStatus {
  EXCELLENT
  GOOD
  NEEDS_IMPROVEMENT
}

enum OrderStatus {
  DRAFT
  OPEN
  ACTIVE
  IN_PROGRESS
  IN_REVIEW
  COMPLETED
  CANCELLED
  EXPIRED
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum SettingsChangeType {
  FIRST_NAME
  LAST_NAME
  EMAIL_ADDRESS
  COMPANY_NAME
  TAX_NUMBER
}

enum AssignmentStatus {
  ASSIGNED
  ACTIVE
  COMPLETED
  CANCELLED
  OVERDUE
}

enum AssignmentTier {
  PRIMARY
  BACKUP
  FALLBACK
}

enum DocumentType {
  RESUME
  ID_CARD
  PASSPORT
  CONTRACT
  CERTIFICATE
  WORK_EVIDENCE
  PROFILE_PICTURE
  OTHER
}

enum NoteCategory {
  COMPLETION_REQUEST
  ADMIN_RESPONSE
  GENERAL_UPDATE
  ISSUE_REPORT
}

enum AbsenceType {
  SICK_LEAVE
  VACATION
  PERSONAL_LEAVE
  MATERNITY_LEAVE
  PATERNITY_LEAVE
  UNPAID_LEAVE
  BEREAVEMENT_LEAVE
  OTHER
}

enum WorkScheduleType {
  FULL_TIME
  PART_TIME
  CONTRACT
  TEMPORARY
  INTERN
}

// ===============================
// CORE ENTITIES
// ===============================

model User {
  id        String    @id @default(cuid())
  email     String?   @unique
  username  String    @unique
  password  String
  role      UserRole  @default(EMPLOYEE)
  isActive  Boolean   @default(true)
  lastLogin DateTime?

  refreshToken             String?
  emailVerificationToken   String?
  emailVerificationExpires DateTime?
  passwordResetToken       String?
  passwordResetExpires     DateTime?
  emailVerified            Boolean   @default(false)
  twoFactorEnabled         Boolean   @default(false)
  twoFactorSecret          String?

  // Cascade delete relations
  employee        Employee?
  customer        Customer?
  manualOverrides EmployeePerformance[] @relation("ManualOverrideByUser")

  // Manager relationships
  subordinates Employee[] @relation("ManagerSubordinate")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  // Notification relationships
  notificationRecipients  NotificationRecipient[]
  notificationPreferences NotificationPreference?
  orderNotes              OrderNote[]
  settingsChangeRequests  SettingsChangeRequest[]

  @@map("users")
}

enum TrafficLight {
  RED
  YELLOW
  GREEN
}

model Employee {
  id           String @id @default(cuid())
  employeeCode String @unique

  firstName        String?
  lastName         String?
  phoneNumber      String?
  dateOfBirth      DateTime?
  address          String?
  emergencyContact Json?

  hireDate        DateTime
  terminationDate DateTime?
  department      Department? @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  departmentId    String?
  position        Position?   @relation(fields: [positionId], references: [id], onDelete: Cascade)
  positionId      String?
  manager         User?       @relation("ManagerSubordinate", fields: [managerId], references: [id], onDelete: Cascade)
  managerId       String?

  scheduleType WorkScheduleType @default(FULL_TIME)
  hourlyRate   Decimal?         @db.Decimal(10, 2)
  salary       Decimal?         @db.Decimal(12, 2)
  isAvailable  Boolean          @default(true)
  priority     Int              @default(1)

  blockedAt     DateTime?
  blockedReason String?

  performanceScore   Decimal?              @db.Decimal(5, 2) // current computed score
  trafficLight       TrafficLight? // current traffic light en
  performanceRecords EmployeePerformance[]

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique

  qualifications   EmployeeQualification[]
  assignments      Assignment[]
  absences         Absence[]
  ratings          Rating[]
  workStatistics   WorkStatistic[]
  orderAssignments OrderAssignment[]
  files            File[]

  // Team relationships
  teamMemberships TeamMember[]
  ledTeams        Team[]       @relation("TeamLeader")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@map("employees")
}

model EmployeePerformance {
  id         String   @id @default(cuid())
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String

  periodStart        DateTime
  periodEnd          DateTime
  score              Decimal      @db.Decimal(5, 2)
  trafficLight       TrafficLight
  trafficLightReason String? // <-- NEW FIELD

  metrics            Json? // weighted contributions + other details
  manualOverride     Boolean @default(false)
  manualOverrideById String?
  manualOverrideBy   User?   @relation("ManualOverrideByUser", fields: [manualOverrideById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId, periodStart])
  @@map("employee_performance")
}

model PerformanceThreshold {
  id           String     @id @default(cuid())
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  departmentId String

  // thresholds stored as inclusive ranges
  redMin    Int
  redMax    Int
  yellowMin Int
  yellowMax Int
  greenMin  Int
  greenMax  Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([departmentId]) // one threshold config per department
  @@map("performance_thresholds")
}

model Department {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  code        String  @unique
  isActive    Boolean @default(true)

  parentDepartment Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  parentId         String?
  childDepartments Department[] @relation("DepartmentHierarchy")

  employees            Employee[]
  positions            Position[]
  performanceThreshold PerformanceThreshold? // back relation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("departments")
}

model Position {
  id          String  @id @default(cuid())
  title       String
  description String?
  level       Int     @default(1)
  isActive    Boolean @default(true)

  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  departmentId String

  minSalary Decimal? @db.Decimal(12, 2)
  maxSalary Decimal? @db.Decimal(12, 2)

  employees Employee[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([title, departmentId])
  @@map("positions")
}

// ===============================
// CUSTOMER & ORDER MANAGEMENT
// ===============================

model Customer {
  id           String  @id @default(cuid())
  companyName  String
  contactEmail String?
  contactPhone String?
  address      Json?
  isActive     Boolean @default(true)

  industry  String?
  taxNumber String? @unique

  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String? @unique

  subAccounts SubAccount[]
  orders      Order[]
  ratings     Rating[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("customers")
}

model SubAccount {
  id       String  @id @default(cuid())
  name     String
  code     String?
  isActive Boolean @default(true)

  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  customerId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([customerId, name])
  @@map("sub_accounts")
}

model Order {
  id          String  @id @default(cuid())
  orderNumber String  @unique
  title       String?
  description String?

  scheduledDate DateTime
  startTime     DateTime?
  endTime       DateTime?
  duration      Int?
  location      String?

  requiredEmployees   Int     @default(1)
  priority            Int     @default(1)
  specialInstructions String?

  status OrderStatus @default(DRAFT)

  // Archive fields for weekly archiving
  isArchived Boolean   @default(false)
  archivedAt DateTime?

  // Estimated and actual hours for tracking
  estimatedHours Decimal? @db.Decimal(5, 2)
  actualHours    Decimal? @db.Decimal(5, 2)

  customer            Customer             @relation(fields: [customerId], references: [id], onDelete: Cascade)
  customerId          String
  team                Team?                @relation(fields: [teamId], references: [id], onDelete: SetNull)
  teamId              String?
  qualifications      OrderQualification[]
  orderAssignments    OrderAssignment[]
  employeeAssignments Assignment[]
  ratings             Rating[]
  files               File[]
  notes               OrderNote[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([isArchived, scheduledDate])
  @@map("orders")
}

// ===============================
// QUALIFICATIONS & SKILLS
// ===============================

model Qualification {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  category    String?
  isActive    Boolean @default(true)

  requiresCertificate Boolean @default(false)
  expiryMonths        Int?

  employeeQualifications EmployeeQualification[]
  orderQualifications    OrderQualification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("qualifications")
}

model EmployeeQualification {
  id String @id @default(cuid())

  employee        Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId      String
  qualification   Qualification @relation(fields: [qualificationId], references: [id], onDelete: Cascade)
  qualificationId String

  acquiredDate     DateTime  @default(now())
  expiryDate       DateTime?
  certificateUrl   String?
  isVerified       Boolean   @default(false)
  proficiencyLevel Int       @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, qualificationId])
  @@map("employee_qualifications")
}

model OrderQualification {
  id String @id @default(cuid())

  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId         String
  qualification   Qualification @relation(fields: [qualificationId], references: [id], onDelete: Cascade)
  qualificationId String

  required       Boolean @default(true)
  minProficiency Int     @default(1)

  @@unique([orderId, qualificationId])
  @@map("order_qualifications")
}

// ===============================
// ASSIGNMENTS & WORK TRACKING
// ===============================

model Assignment {
  id String @id @default(cuid())

  order      Order?   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId    String?
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String

  assignedDate DateTime         @default(now())
  startDate    DateTime?
  endDate      DateTime?
  status       AssignmentStatus @default(ASSIGNED)
  tier         AssignmentTier   @default(PRIMARY)

  estimatedHours Decimal? @db.Decimal(5, 2)
  actualHours    Decimal? @db.Decimal(5, 2)
  notes          String?
  files          File[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@map("assignments")
}

model OrderAssignment {
  id String @id @default(cuid())

  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId    String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String

  role       String?
  hourlyRate Decimal? @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orderId, employeeId])
  @@map("order_assignments")
}

// ===============================
// ABSENCE MANAGEMENT
// ===============================

model Absence {
  id String @id @default(cuid())

  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String

  type      AbsenceType
  startDate DateTime
  endDate   DateTime
  reason    String?
  status    RequestStatus @default(PENDING)

  approvedBy      String?
  approvedAt      DateTime?
  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?

  documentUrls String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("absences")
}

// ===============================
// PERFORMANCE & RATINGS
// ===============================

model Rating {
  id String @id @default(cuid())

  order      Order?    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId    String?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)
  customerId String?

  rating   Int
  comment  String?
  category String?
  status   RatingStatus

  ratedBy    String?
  ratingDate DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ratings")
}

// ===============================
// WORK STATISTICS & REPORTING
// ===============================

model WorkStatistic {
  id   String   @id @default(cuid())
  date DateTime @db.Date

  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String

  hoursWorked   Decimal  @db.Decimal(5, 2)
  overtimeHours Decimal  @default(0) @db.Decimal(5, 2)
  location      String?
  projects      String[]

  efficiency   Decimal? @db.Decimal(3, 2)
  qualityScore Decimal? @db.Decimal(3, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, date])
  @@map("work_statistics")
}

// ===============================
// NOTIFICATIONS
// ===============================

model NotificationTemplate {
  id              String   @id @default(cuid())
  key             String   @unique // e.g. "ASSIGNMENT_CREATED"
  title           String
  body            String // templated string (handlebars/mustache)
  defaultChannels String[] // ["in_app","email"]
  isActive        Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("notification_templates")
}

model Notification {
  id          String   @id @default(cuid())
  templateKey String?
  title       String
  body        String
  data        Json? // arbitrary payload (orderId, assignmentId...)
  category    String? // e.g. "assignment", "absence"
  createdBy   String?
  createdAt   DateTime @default(now())

  recipients         NotificationRecipient[]
  deliveredAt        DateTime?
  status             String                  @default("PENDING") // PENDING, SENT, FAILED, READ
  NotificationOutbox NotificationOutbox[]

  @@index([createdAt])
  @@map("notifications")
}

model NotificationRecipient {
  id             String       @id @default(cuid())
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  notificationId String
  user           User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String?
  channels       String[] // ["in_app","email","push"]
  readAt         DateTime?
  seenAt         DateTime?
  isArchived     Boolean      @default(false)
  status         String       @default("PENDING") // PENDING, SENT, FAILED
  error          String?

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@map("notification_recipients")
}

// Outbox for transactional safety (optional alternative to enqueueing directly)
model NotificationOutbox {
  id             String        @id @default(cuid())
  notification   Notification? @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  notificationId String?
  payload        Json
  channel        String
  attempts       Int           @default(0)
  maxAttempts    Int           @default(5)
  lockedUntil    DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([lockedUntil])
  @@map("notification_outbox")
}

// User preferences for channels and throttling
model NotificationPreference {
  id              String   @id @default(cuid())
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String   @unique
  channels        String[] @default(["in_app", "email"])
  quietHoursStart Int? // minutes from 00:00
  quietHoursEnd   Int? // minutes from 00:00
  digestEnabled   Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("notification_preferences")
}

// ===============================
// ORDER NOTES
// ===============================

model OrderNote {
  id             String       @id @default(cuid())
  orderId        String
  authorId       String
  content        String
  triggersStatus OrderStatus?
  category       NoteCategory @default(GENERAL_UPDATE)
  isInternal     Boolean      @default(false)

  order  Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  author User  @relation(fields: [authorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId, createdAt])
  @@map("order_notes")
}

// ===============================
// FILE MANAGEMENT
// ===============================

model File {
  id           String @id @default(cuid())
  filename     String // stored filename
  originalName String // original uploaded filename
  mimeType     String
  size         Int // file size in bytes
  path         String // file storage path

  documentType DocumentType @default(OTHER)
  description  String?
  expiryDate   DateTime?

  // Relations
  employee     Employee?   @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId   String?
  order        Order?      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId      String?
  assignment   Assignment? @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  assignmentId String?

  // Metadata
  uploadedBy String? // userId who uploaded
  isVerified Boolean @default(false)
  isPublic   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("files")
}

// ===============================
// SETTINGS CHANGE REQUESTS
// ===============================

model SettingsChangeRequest {
  id             String             @id @default(cuid())
  userId         String
  requestType    SettingsChangeType
  currentValue   String?
  requestedValue String
  reason         String?
  status         RequestStatus      @default(PENDING)
  reviewedBy     String?
  reviewedAt     DateTime?
  reviewNotes    String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status])
  @@index([status, createdAt])
  @@map("settings_change_requests")
}

// ===============================
// TEAMS
// ===============================

model Team {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  isActive    Boolean @default(true)

  teamLeader   Employee? @relation("TeamLeader", fields: [teamLeaderId], references: [id], onDelete: SetNull)
  teamLeaderId String?   @unique

  members TeamMember[]
  orders  Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("teams")
}

model TeamMember {
  id String @id @default(cuid())

  team       Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  teamId     String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String

  joinedAt DateTime  @default(now())
  leftAt   DateTime?
  isActive Boolean   @default(true)

  @@unique([teamId, employeeId])
  @@map("team_members")
}

// ===============================
// SYSTEM CONFIGURATION
// ===============================

model SystemConfig {
  id    String @id @default(cuid())
  key   String @unique
  value String

  description String?
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_config")
}

// ===============================
// AUDIT LOG
// ===============================

model AuditLog {
  id String @id @default(cuid())

  tableName String
  recordId  String
  action    String
  oldData   Json?
  newData   Json?
  changes   Json?

  userId    String?
  timestamp DateTime @default(now())
  ipAddress String?
  userAgent String?

  @@index([tableName, recordId])
  @@index([userId, timestamp])
  @@map("audit_logs")
}
