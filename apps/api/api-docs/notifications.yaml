openapi: 3.0.3
info:
  title: Employee Management - Notifications API
  description: |
    API for creating, fetching and managing notifications (in-app, email, push).
    Includes preferences and sample/mock payloads for testing.
  version: 1.0.0
servers:
  - url: http://localhost:3000/api
    description: Local development server
tags:
  - name: Notifications
    description: Notification CRUD and recipient actions
  - name: Preferences
    description: User notification preference management

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Notification:
      type: object
      properties:
        id:
          type: string
          example: "ckxyz12300000000000000001"
        templateKey:
          type: string
          nullable: true
          example: "ASSIGNMENT_CREATED"
        title:
          type: string
          example: "New Assignment: Order #ORD-1001"
        body:
          type: string
          example: "You have been assigned to Order ORD-1001 starting 2025-09-25."
        data:
          type: object
          additionalProperties: true
          example:
            assignmentId: "asgmt_01"
            orderId: "ORD-1001"
            startDate: "2025-09-25T09:00:00.000Z"
        category:
          type: string
          example: "assignment"
        createdBy:
          type: string
          example: "user_ckadmin01"
        status:
          type: string
          example: "SENT"
        deliveredAt:
          type: string
          format: date-time
          nullable: true

    NotificationRecipient:
      type: object
      properties:
        id:
          type: string
          example: "recp_ck001"
        userId:
          type: string
          example: "user_ckemployee01"
        channels:
          type: array
          items:
            type: string
            example: "in_app"
        readAt:
          type: string
          format: date-time
          nullable: true
        seenAt:
          type: string
          format: date-time
          nullable: true
        isArchived:
          type: boolean
          example: false
        status:
          type: string
          example: "PENDING"
        createdAt:
          type: string
          format: date-time
          example: "2025-09-24T12:34:56.000Z"
        notification:
          $ref: "#/components/schemas/Notification"

    CreateNotificationRequest:
      type: object
      required:
        - title
        - body
        - recipients
      properties:
        templateKey:
          type: string
          nullable: true
          example: "ASSIGNMENT_CREATED"
        title:
          type: string
          example: "You were assigned to a new order"
        body:
          type: string
          example: "Please review the details for your new assignment."
        data:
          type: object
          additionalProperties: true
          example:
            assignmentId: "asgmt_01"
            orderId: "ORD-1001"
        recipients:
          type: array
          items:
            type: object
            required:
              - userId
            properties:
              userId:
                type: string
                example: "user_ckemployee01"
              channels:
                type: array
                items:
                  type: string
                example: ["in_app", "email"]

    PaginatedRecipients:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/NotificationRecipient"
        meta:
          type: object
          properties:
            page:
              type: integer
              example: 1
            limit:
              type: integer
              example: 20
            total:
              type: integer
              example: 42

    Preference:
      type: object
      properties:
        userId:
          type: string
          example: "user_ckemployee01"
        channels:
          type: array
          items:
            type: string
          example: ["in_app", "email"]
        quietHoursStart:
          type: integer
          nullable: true
          description: Minutes from 00:00 (e.g., 1320 == 22:00)
          example: 1320
        quietHoursEnd:
          type: integer
          nullable: true
          example: 420
        digestEnabled:
          type: boolean
          example: false
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

  examples:
    CreateNotificationExample:
      summary: Create notification for two recipients
      value:
        templateKey: "ASSIGNMENT_CREATED"
        title: "Assigned to Order ORD-1001"
        body: "You have a new assignment scheduled for 2025-09-25 at 09:00."
        data:
          assignmentId: "asgmt_01"
          orderId: "ORD-1001"
          startDate: "2025-09-25T09:00:00.000Z"
        recipients:
          - userId: "user_ckemployee01"
            channels: ["in_app", "email"]
          - userId: "user_ckemployee02"
            channels: ["in_app"]

    NotificationRecipientExample:
      summary: Example recipient item
      value:
        id: "recp_ck001"
        userId: "user_ckemployee01"
        channels: ["in_app", "email"]
        readAt: null
        seenAt: null
        isArchived: false
        status: "PENDING"
        createdAt: "2025-09-24T12:34:56.000Z"
        notification:
          id: "ckxyz12300000000000000001"
          templateKey: "ASSIGNMENT_CREATED"
          title: "New Assignment: Order #ORD-1001"
          body: "You have been assigned to Order ORD-1001 starting 2025-09-25."
          data:
            assignmentId: "asgmt_01"
            orderId: "ORD-1001"
            startDate: "2025-09-25T09:00:00.000Z"
          category: "assignment"
          createdBy: "user_ckadmin01"
          status: "PENDING"
          deliveredAt: null

    PreferencesExample:
      summary: Notification preferences example
      value:
        userId: "user_ckemployee01"
        channels: ["in_app", "email"]
        quietHoursStart: 1320
        quietHoursEnd: 420
        digestEnabled: false
        createdAt: "2025-09-01T00:00:00.000Z"
        updatedAt: "2025-09-10T08:00:00.000Z"

security:
  - bearerAuth: []

paths:
  /notifications:
    get:
      tags:
        - Notifications
      summary: Get notifications for current user (paginated)
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            default: 1
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
      responses:
        "200":
          description: Paginated list of notification recipient rows
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaginatedRecipients"
              examples:
                sample:
                  $ref: "#/components/examples/NotificationRecipientExample"
        "401":
          description: Unauthorized

    post:
      tags:
        - Notifications
      summary: Create a notification (system)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateNotificationRequest"
            examples:
              create:
                $ref: "#/components/examples/CreateNotificationExample"
      responses:
        "201":
          description: Notification created (enqueued for processing)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Notification"
              examples:
                created:
                  value:
                    id: "ckxyz12300000000000000001"
                    templateKey: "ASSIGNMENT_CREATED"
                    title: "Assigned to Order ORD-1001"
                    body: "You have a new assignment scheduled for 2025-09-25 at 09:00."
                    data:
                      assignmentId: "asgmt_01"
                    createdBy: "user_ckadmin01"
                    status: "PENDING"
        "400":
          description: Bad request (missing recipients, invalid payload)
        "401":
          description: Unauthorized
        "403":
          description: Forbidden (insufficient role)

  /notifications/unread-count:
    get:
      tags:
        - Notifications
      summary: Get unread notification count for current user
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Unread count
          content:
            application/json:
              schema:
                type: object
                properties:
                  unreadCount:
                    type: integer
                    example: 3
        "401":
          description: Unauthorized

  /notifications/{recipientId}:
    get:
      tags:
        - Notifications
      summary: Get a single notification recipient row (owner only)
      security:
        - bearerAuth: []
      parameters:
        - name: recipientId
          in: path
          required: true
          schema:
            type: string
            example: "recp_ck001"
          description: The notification recipient ID
      responses:
        "200":
          description: Notification recipient with notification
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NotificationRecipient"
              examples:
                single:
                  $ref: "#/components/examples/NotificationRecipientExample"
        "401":
          description: Unauthorized
        "403":
          description: Forbidden
        "404":
          description: Not found

  /notifications/{recipientId}/read:
    post:
      tags:
        - Notifications
      summary: Mark notification as read for the current user (by recipient id)
      security:
        - bearerAuth: []
      parameters:
        - name: recipientId
          in: path
          required: true
          schema:
            type: string
            example: "recp_ck001"
          description: The notification recipient ID
      responses:
        "204":
          description: Marked as read
        "401":
          description: Unauthorized
        "403":
          description: Forbidden
        "404":
          description: Not found

  /notifications/{recipientId}/archive:
    post:
      tags:
        - Notifications
      summary: Archive a notification for the current user
      security:
        - bearerAuth: []
      parameters:
        - name: recipientId
          in: path
          required: true
          schema:
            type: string
            example: "recp_ck001"
          description: The notification recipient ID
      responses:
        "204":
          description: Archived
        "401":
          description: Unauthorized
        "403":
          description: Forbidden
        "404":
          description: Not found

  /notifications/preferences:
    get:
      tags:
        - Preferences
      summary: Get current user's notification preferences (or defaults)
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Preference object (created if none)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Preference"
              examples:
                pref:
                  $ref: "#/components/examples/PreferencesExample"
        "401":
          description: Unauthorized

    put:
      tags:
        - Preferences
      summary: Update current user's notification preferences
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                channels:
                  type: array
                  items:
                    type: string
                  example: ["in_app", "email"]
                quietHoursStart:
                  type: integer
                  nullable: true
                  example: 1320
                quietHoursEnd:
                  type: integer
                  nullable: true
                  example: 420
                digestEnabled:
                  type: boolean
                  example: false
      responses:
        "200":
          description: Updated preference
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Preference"
        "400":
          description: Invalid input
        "401":
          description: Unauthorized
  /notifications/{notificationId}/status:
    put:
      tags:
        - Notifications
      summary: Update notification status
      description: Update the status of a notification (e.g., PENDING, SENT, FAILED).
      security:
        - bearerAuth: []
      parameters:
        - name: notificationId
          in: path
          required: true
          schema:
            type: string
            example: "ckxyz12300000000000000001"
          description: The notification ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [PENDING, SENT, FAILED]
                  example: "SENT"
                deliveredAt:
                  type: string
                  format: date-time
                  example: "2025-01-01T12:00:00Z"
              required:
                - status
      responses:
        "200":
          description: Updated notification
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Notification"
        "400":
          description: Invalid status value
        "401":
          description: Unauthorized
        "403":
          description: Forbidden
        "404":
          description: Notification not found

  /notifications/recipients/{recipientId}/status:
    put:
      tags:
        - Notifications
      summary: Update recipient delivery status
      description: Update the delivery status of a recipient (e.g., mark as SENT, FAILED with error message).
      security:
        - bearerAuth: []
      parameters:
        - name: recipientId
          in: path
          required: true
          schema:
            type: string
            example: "recp_ck001"
          description: The notification recipient ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [PENDING, SENT, FAILED]
                  example: FAILED
                error:
                  type: string
                  nullable: true
                  example: "Email delivery failed"
      responses:
        "200":
          description: Updated recipient record
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NotificationRecipient"
              examples:
                failedStatus:
                  value:
                    id: "recp_ck001"
                    userId: "user_ckemployee01"
                    channels: ["in_app", "email"]
                    status: "FAILED"
                    error: "Email delivery failed"
                    createdAt: "2025-09-24T12:34:56.000Z"
                    notification:
                      id: "ckxyz12300000000000000001"
                      title: "New Assignment: Order #ORD-1001"
                      body: "You have been assigned to Order ORD-1001 starting 2025-09-25."
                      status: "SENT"
        "400":
          description: Invalid input
        "401":
          description: Unauthorized
        "403":
          description: Forbidden
        "404":
          description: Recipient not found
